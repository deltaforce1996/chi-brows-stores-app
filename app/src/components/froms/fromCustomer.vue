<template>
  <v-row justify="center">
    <v-col cols="12" class="pa-2">
      <v-form ref="formRef" @submit.prevent="submitForm">
        <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß -->
        <v-card class="pa-6 mb-6" outlined>
          <v-card-title class="text-red font-weight-bold">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</v-card-title>
          <v-row>
            <v-col cols="12" md="6">
              <v-text-field label="‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•" v-model="form.fullName" :rules="[requiredRule]" variant="outlined" />
            </v-col>
            <v-col cols="12" md="6">
              <v-text-field label="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô" v-model="form.nickname" :rules="[requiredRule]" variant="outlined" />
            </v-col>
            <v-col cols="12" md="6">
              <v-text-field label="Facebook" v-model="form.facebook" :rules="[requiredRule]" variant="outlined" />
            </v-col>
            <v-col cols="12" md="6">
              <v-text-field label="Line" v-model="form.line" :rules="[requiredRule]" variant="outlined" />
            </v-col>
            <v-col cols="12" md="6">
              <v-text-field label="‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà" v-model="form.address" :rules="[requiredRule]" variant="outlined" />
            </v-col>
            <v-col cols="12" md="6">
              <v-text-field label="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£" v-model="form.phone" :rules="[requiredRule]" variant="outlined" />
            </v-col>
            <v-col cols="12" md="6">
              <v-text-field
                label="‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î"
                v-model="form.birthday"
                type="date"
                :rules="[requiredRule]"
                variant="outlined"
                prepend-inner-icon="mdi-calendar"
                density="compact"
              />
            </v-col>
          </v-row>
        </v-card>

        <!-- ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ -->
        <v-card class="pa-6 mb-6" outlined>
          <v-card-title class="text-red font-weight-bold">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</v-card-title>
          <v-row>
            <v-col cols="12">
              <v-select
                label="‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£"
                :items="productOptions"
                item-title="title"
                item-value="value"
                v-model="form.serviceType"
                placeholder="‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏∞"
                :rules="[requiredRule]"
                variant="outlined"
                clearable
              />
            </v-col>
            <v-col cols="12">
              <v-text-field
                label="‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß"
                v-model="form.medicalCondition"
                :rules="[requiredRule]"
                variant="outlined"
              />
            </v-col>
            <v-col cols="12">
              <v-text-field
                v-model="form.price"
                label="‡∏£‡∏≤‡∏Ñ‡∏≤"
                type="number"
                :rules="[requiredRule]"
                variant="outlined"
              />
            </v-col>
            <v-col cols="12">
              <v-select
                label="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£"
                :items="employeeOptions"
                item-title="title"
                item-value="value"
                v-model="form.provider"
                placeholder="‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏∞"
                :rules="[requiredRule]"
                variant="outlined"
                clearable
                density="compact"
              />
            </v-col>
            <v-col cols="12">
              <v-text-field
                label="‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà - ‡πÄ‡∏ß‡∏•‡∏≤"
                v-model="form.datetime"
                type="date"
                :rules="[requiredRule]"
                variant="outlined"
                prepend-inner-icon="mdi-calendar"
                density="compact"
              />
            </v-col>
          </v-row>
        </v-card>

        <!-- ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö) -->
<v-card class="pa-6 mb-6" outlined>
  <v-card-title class="text-red font-weight-bold">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</v-card-title>
  <v-row justify="center">
    <v-col cols="12" md="6">
      <v-file-input
        v-model="form.image"
        accept="image/*"
        label="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û"
        prepend-icon="mdi-cloud-upload"
        show-size
        clearable
        variant="outlined"
      />
    </v-col>
  </v-row>
</v-card>

        <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏ñ‡∏±‡∏î‡πÑ‡∏õ -->
        <v-card-actions class="justify-center">
          <v-btn class="next-button" type="submit" variant="outlined">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</v-btn>
        </v-card-actions>
      </v-form>
    </v-col>
  </v-row>
</template>

<script setup>
import { ref, onMounted } from "vue";
import { searchProducts } from "@/services/productService";
import { searchEmployees } from "@/services/employeeService";

// Emit to parent
const emit = defineEmits(["submit"]);

// Form data
const form = ref({
  fullName: "",
  nickname: "",
  facebook: "",
  line: "",
  address: "",
  phone: "",
  birthday: "",
  serviceType: null,
  price: "",
  medicalCondition: "",
  provider: null,
  datetime: "",
  image: null,
});

// Validation setup
const formRef = ref();
const requiredRule = (v) => !!v || "‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";

// Options
const productOptions = ref([]);
const employeeOptions = ref([]);

onMounted(async () => {
  try {
    const res = await searchEmployees({}, 1, 100);
    employeeOptions.value = res.items.map((emp) => ({
      title: emp.fullname,
      value: emp.id,
    }));
  } catch (err) {
    console.error("‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:", err);
  }

  try {
    const res = await searchProducts("");
    productOptions.value = res.map((prod) => ({
      title: prod.name,
      value: prod.id,
    }));
  } catch (err) {
    console.error("‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:", err);
  }
});

async function submitForm() {
  const { valid } = await formRef.value.validate();
  if (!valid) {
    console.warn("‚ùå ‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö");
    return;
  }

  console.log("üì§ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:", form.value);
  emit("submit", form.value);
}

// Handle file upload
// function onFileChange(e) {
//   const file = e.target.files[0];
//   if (file) {
//     form.value.image = file;
//     console.log("üì∏ ‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å:", file.name);
//   }
// }
</script>

<style scoped>
.next-button {
  background-color: #d66b63;
  color: white;
  border-radius: 8px;
  min-width: 100px;
  height: 40px;
  text-transform: none;
  font-weight: bold;
  font-size: 14px;
}

.upload-area {
  border: 2px dashed red;
  border-radius: 12px;
  padding: 40px 20px;
  width: 100%;
  max-width: 400px;
  text-align: center;
  cursor: pointer;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  transition: border-color 0.3s;
  background-color: white;
}

.upload-area:hover {
  border-color: darkred;
}

.upload-label {
  margin-top: 8px;
  font-size: 14px;
  font-weight: 500;
  color: black;
}
</style>
